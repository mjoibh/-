<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher AI - Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase (Required for Authentication, Chat, Library persistence) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let globalUserId = null;
        let isAuthReady = false;

        // Initialize Firebase and Auth
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set up authentication listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    globalUserId = user.uid;
                    document.getElementById('user-id-display').textContent = globalUserId;
                    // Start data listeners once auth is ready
                    startFirestoreListeners(globalUserId);
                } else {
                    // This case should ideally not happen after initial sign-in
                    globalUserId = 'anonymous-' + crypto.randomUUID();
                    document.getElementById('user-id-display').textContent = globalUserId;
                    startFirestoreListeners(globalUserId);
                }
                isAuthReady = true;
                // Try to load last file upon ready
                if (window.loadLastOpenedFile) {
                    window.loadLastOpenedFile();
                }
            });

            // Sign in with custom token or anonymously
            async function authenticateUser() {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            }
            authenticateUser();
            
            // Expose DB instance globally for other scripts
            window.db = db;
            window.auth = auth;
            window.getUserId = () => globalUserId;
            window.isAuthReady = () => isAuthReady; 
            window.firestoreImports = { doc, setDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, getDoc, updateDoc };

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            window.handleError(`Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        :root {
            --primary-blue: #3b82f6; /* Tailwind blue-500 */
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            direction: rtl;
            text-align: right;
        }
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-blue);
            border-radius: 4px;
        }
        /* Custom style for active tab indicator */
        .tab-button.active {
            border-bottom: 3px solid var(--primary-blue);
            color: var(--primary-blue);
        }
        /* Custom style to handle RTL for text alignment where needed */
        .text-left-ar {
            text-align: right; /* Use right for Arabic text */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Access Gate Modal -->
    <div id="access-gate" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù†ØµØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ</h1>
            <p class="text-gray-600 mb-6">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
            <input type="password" id="access-key-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500 mb-4 text-left-ar">
            <button onclick="checkAccessKey()" class="w-full bg-blue-600 hover:bg-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </button>
            <p id="key-error-message" class="text-red-500 mt-4 hidden">Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
            <p id="key-lost-message" class="text-gray-500 mt-6 text-sm hidden">
                Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹: <span class="font-bold text-blue-600">0908633152</span>
            </p>
        </div>
    </div>

    <!-- Main Application Interface (Hidden until unlocked) -->
    <div id="main-app" class="flex flex-col flex-grow hidden">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-40">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <h1 class="text-2xl font-extrabold text-blue-600 flex items-center">
                    <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l-6.16-3.422a12.083 12.083 0 00-.665 6.479A11.952 11.952 0 0112 20.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14L12 14"></path></svg>
                    Teacher AI
                </h1>
                <div class="text-sm text-gray-500 hidden sm:block">
                    Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ: <span id="user-id-display" class="font-mono text-xs text-blue-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
                <button id="toggle-sidebar" class="md:hidden p-2 text-blue-600 rounded-lg hover:bg-blue-100 transition">
                    <!-- Icon for Menu -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex flex-grow max-w-7xl mx-auto w-full">
            <!-- Sidebar/Drawers (For Mobile, hidden by default) -->
            <div id="sidebar" class="fixed inset-y-0 right-0 z-30 w-64 bg-white border-l border-gray-200 transform translate-x-full md:relative md:translate-x-0 md:flex md:flex-col md:w-80 p-4 space-y-4 transition-transform duration-300 md:shadow-none shadow-xl scroll-container overflow-y-auto">
                
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø®Ø§ØµØ©</h2>
                <div class="space-y-2 text-sm max-h-40 overflow-y-auto scroll-container border p-2 rounded-lg bg-gray-50">
                    <p id="library-loading" class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª...</p>
                    <div id="library-list" class="space-y-1">
                        <!-- Library Items will be loaded here -->
                    </div>
                </div>

                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
                <div id="key-concepts-display" class="space-y-2 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm max-h-56 overflow-y-auto scroll-container">
                    <!-- This will be populated by displayKeyConcepts -->
                    <p class="text-gray-600">Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ…" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§.</p>
                </div>

                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <div id="group-chat-area" class="flex flex-col flex-grow bg-white border rounded-lg shadow-inner h-64">
                    <div id="group-chat-messages" class="flex-grow p-3 space-y-3 overflow-y-auto scroll-container text-xs">
                        <p class="text-center text-gray-500 pt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
                        <!-- Group Chat messages will be loaded here -->
                    </div>
                    <div class="border-t p-2 flex">
                        <input type="text" id="group-chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù†Ù‚Ø§Ø´..." class="flex-grow px-3 py-2 border border-gray-300 rounded-r-lg focus:outline-none text-left-ar text-sm">
                        <button onclick="sendGroupChatMessage()" class="bg-blue-600 text-white p-2 rounded-l-lg hover:bg-blue-700 transition duration-150">
                            Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                </div>

                <!-- Button to trigger detailed analysis via AI Chat -->
                <button onclick="extractConceptsToSidebar()" id="extract-concepts-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md disabled:bg-gray-400" disabled>
                    Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ… âœ¨
                </button>

                <button id="close-sidebar" class="md:hidden absolute top-4 left-4 text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Main Document/Chat Area -->
            <div class="flex-grow p-4 md:p-6 bg-white shadow-xl md:shadow-none md:border-r w-full">
                
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="tab-doc" onclick="changeTab('document')" class="tab-button active flex-1 text-center py-3 px-4 font-semibold text-gray-600 transition duration-150">
                        Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ
                    </button>
                    <button id="tab-search" onclick="changeTab('ai-search')" class="tab-button flex-1 text-center py-3 px-4 font-semibold text-gray-600 transition duration-150">
                        Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ“š
                    </button>
                    <button id="tab-chat" onclick="changeTab('ai-chat')" class="tab-button flex-1 text-center py-3 px-4 font-semibold text-gray-600 transition duration-150">
                        Ø³Ø¤Ø§Ù„ ÙˆØ¬ÙˆØ§Ø¨ ÙÙˆØ±ÙŠ (AI)
                    </button>
                </div>

                <!-- Document and AI Teacher Tab Content -->
                <div id="tab-content-document" class="space-y-6">
                    <div class="flex flex-col sm:flex-row gap-4 items-center p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <label for="file-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-200 shadow-lg whitespace-nowrap">
                            Ø±ÙØ¹ Ù…Ù„Ù Ù„Ù„Ø¯Ø±Ø§Ø³Ø©
                        </label>
                        <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(event)" accept=".pdf,.doc,.docx,.txt,image/*">
                        <span id="file-name-display" class="text-gray-700 text-sm">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù.</span>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                             <!-- Summary Button (New Feature) -->
                            <button onclick="summarizeDocument()" id="summarize-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full transition duration-200 shadow-md disabled:bg-gray-400" disabled>
                                ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ âœ¨
                            </button>

                            <button onclick="translateAndAnalyze()" id="analyze-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-200 shadow-md disabled:bg-gray-400" disabled>
                                ØªØ±Ø¬Ù…Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            </button>
                        </div>
                    </div>

                    <div id="document-view" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Original Content Pane -->
                        <div class="bg-gray-50 p-4 border border-gray-200 rounded-lg shadow-inner h-[60vh] overflow-y-auto scroll-container">
                            <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-2">Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ (<span id="original-lang">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø£ØµÙ„</span>)</h3>
                            <!-- Ensure visibility of all content -->
                            <pre id="original-content" class="whitespace-pre-wrap text-sm text-gray-800 text-left-ar">Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...</pre>
                        </div>

                        <!-- Translated Content Pane -->
                        <div class="bg-white p-4 border border-blue-300 rounded-lg shadow-lg h-[60vh] overflow-y-auto scroll-container relative">
                            <h3 class="text-lg font-bold text-blue-700 border-b pb-2 mb-2">Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØªØ±Ø¬Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</h3>
                            <!-- Ensure visibility of all translated content -->
                            <pre id="translated-content" class="whitespace-pre-wrap text-sm text-gray-800 mt-2 text-left-ar">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù‡Ù†Ø§...</pre>
                        </div>
                    </div>
                </div>

                <!-- AI Search Tab Content (New Library Feature) -->
                 <div id="tab-content-ai-search" class="hidden h-[75vh] flex flex-col">
                    <div class="p-4 bg-gray-100 rounded-t-lg shadow-inner">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                        <div class="flex">
                            <input type="text" id="library-search-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø°ÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡..." class="flex-grow px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-left-ar">
                            <button onclick="searchSmartLibrary()" id="library-search-button" class="bg-blue-600 text-white p-3 rounded-l-lg hover:bg-blue-700 transition duration-150 flex items-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ¥Ø­Ø¶Ø§Ø±Ù‡ Ù„Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡.</p>
                    </div>
                    
                    <div id="library-search-results" class="flex-grow p-4 space-y-4 overflow-y-auto bg-white border-x border-b rounded-b-lg scroll-container">
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <p class="text-yellow-800 font-medium">
                                Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„ÙƒØªØ§Ø¨ ÙˆÙ…Ø­ØªÙˆØ§Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù‡Ù†Ø§. Ø¨Ø¹Ø¯ Ø°Ù„ÙƒØŒ Ø¹Ø¯ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ **"Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ"** Ù„ØªØ±Ø¬Ù…ØªÙ‡ Ø£Ùˆ ØªÙ„Ø®ÙŠØµÙ‡.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Instant Q&A Chat Tab Content -->
                <div id="tab-content-ai-chat" class="hidden h-[75vh] flex flex-col">
                    <div id="ai-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50 border rounded-t-lg scroll-container">
                        <!-- AI Chat messages will be loaded here -->
                        <div class="flex justify-start">
                            <div class="bg-blue-100 p-3 rounded-xl max-w-3/4 shadow-sm text-sm">
                                <p class="font-bold text-blue-800">Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ:</p>
                                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© **Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø© Ù…Ù…ÙƒÙ†Ø©**.</p>
                            </div>
                        </div>
                    </div>
                    <div class="border-t p-4 flex bg-white rounded-b-lg shadow-md">
                        <input type="text" id="ai-chat-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù‡Ù†Ø§..." class="flex-grow px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-left-ar">
                        <button onclick="sendAIChatMessage()" id="ai-send-button" class="bg-blue-600 text-white p-3 rounded-l-lg hover:bg-blue-700 transition duration-150 flex items-center disabled:bg-gray-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white p-4 mt-auto">
            <div class="max-w-7xl mx-auto text-center text-sm">
                &copy; 2024 Teacher AI. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©. | ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Mohamed Gafer
            </div>
        </footer>
    </div>

    <!-- Loading and Error Modal (Custom Modal) -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4 hidden">
        <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-100">
            <div id="modal-spinner" class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4 hidden"></div>
            <p id="modal-message" class="text-gray-700 font-medium text-lg mb-4"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-retry-button" onclick="window.modalAction()" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition hidden">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                <button id="modal-close-button" onclick="closeModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <!-- Core JavaScript Logic -->
    <script>
        // --- Configuration and Constants ---
        const ACCESS_KEY = "Mohamed gafer 123bhfhjufc#";
        
        // IMPORTANT: API Key provided by the user
        const API_KEY_USER = "AIzaSyDmPxYYe7ynW25hEjSP0WyhR21K8eg8LxA";
        const apiKey = API_KEY_USER;
        
        // API URLs must use the new key
        const API_URL_FLASH = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Global state
        let currentDocument = {
            id: null,
            name: null,
            fileSizeMB: 0, 
            originalText: null,
            translatedText: null,
            base64Data: null, 
            mimeType: 'text/plain',
            keyConcepts: { keywords: [], laws: [] } 
        };
        // History size kept small to prioritize speed and stability
        let aiChatHistory = []; 

        // --- Utility Functions ---

        /** Displays a custom modal for loading, success, or error messages. */
        function showModal(message, isError = false, showRetry = false, retryCallback = null) {
            const container = document.getElementById('modal-container');
            const spinner = document.getElementById('modal-spinner');
            const messageEl = document.getElementById('modal-message');
            const retryBtn = document.getElementById('modal-retry-button');
            const closeBtn = document.getElementById('modal-close-button');

            messageEl.textContent = message;
            container.classList.remove('hidden');
            container.classList.add('flex');
            
            if (isError) {
                messageEl.classList.add('text-red-600');
                spinner.classList.add('hidden');
            } else {
                messageEl.classList.remove('text-red-600');
                spinner.classList.add('hidden'); 
            }

            if (showRetry && retryCallback) {
                retryBtn.classList.remove('hidden');
                window.modalAction = retryCallback;
            } else {
                retryBtn.classList.add('hidden');
                window.modalAction = () => closeModal();
            }

            closeBtn.textContent = isError ? 'Ù…ÙˆØ§ÙÙ‚' : 'Ø¥ØºÙ„Ø§Ù‚';
        }

        /** Shows a loading spinner in the modal. */
        function showLoading(message) {
            showModal(message, false, false);
            document.getElementById('modal-spinner').classList.remove('hidden');
            document.getElementById('modal-close-button').classList.add('hidden');
        }

        /** Closes the custom modal. */
        function closeModal() {
            document.getElementById('modal-container').classList.remove('flex');
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-close-button').classList.remove('hidden');
            document.getElementById('modal-message').classList.remove('text-red-600');
        }

        /** Handles general errors gracefully. */
        function handleError(message, callback = null) {
            console.error("Application Error:", message);
            showModal(`Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`, true, !!callback, callback);
        }

        /** Generic fetch wrapper with exponential backoff. */
        async function geminiFetch(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 500 + Math.random() * 500; 
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                    } else if (response.status === 403) {
                         throw new Error("403: Ø®Ø·Ø£ ÙÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„ (API Key). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙØªØ§Ø­.");
                    }
                    const errorDetail = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorDetail}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 500 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Core Application Logic ---

        // --- 1. Access Gate Logic ---
        window.checkAccessKey = function() {
            const input = document.getElementById('access-key-input');
            const errorMsg = document.getElementById('key-error-message');
            const lostMsg = document.getElementById('key-lost-message');

            if (input.value === ACCESS_KEY) {
                document.getElementById('access-gate').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('access-gate').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                }, 300);
            } else {
                errorMsg.classList.remove('hidden');
                lostMsg.classList.remove('hidden');
                input.value = '';
                setTimeout(() => errorMsg.classList.add('hidden'), 5000);
            }
        }

        // --- 2. UI/Tab Management ---
        window.changeTab = function(tabName) {
            ['document', 'ai-search', 'ai-chat'].forEach(name => {
                const button = document.getElementById(`tab-${name === 'document' ? 'doc' : name === 'ai-search' ? 'search' : 'chat'}`);
                const content = document.getElementById(`tab-content-${name}`);
                
                if (name === tabName) {
                    button.classList.add('active');
                    content.classList.remove('hidden');
                } else {
                    button.classList.remove('active');
                    content.classList.add('hidden');
                }
            });
            
            // Close mobile sidebar if open after tab change
            document.getElementById('sidebar').classList.add('translate-x-full');
        }

        document.getElementById('toggle-sidebar').onclick = () => {
            document.getElementById('sidebar').classList.toggle('translate-x-full');
        };
        document.getElementById('close-sidebar').onclick = () => {
            document.getElementById('sidebar').classList.add('translate-x-full');
        };


        // --- 3. File Handling and Persistence (Fast Local Read) ---

        /** Reads the file content, stores it in global state, and prepares for analysis. */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileNameDisplay = document.getElementById('file-name-display');
            const analyzeButton = document.getElementById('analyze-button');
            const summarizeButton = document.getElementById('summarize-button');
            const extractConceptsButton = document.getElementById('extract-concepts-button');
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2); 

            // Reset state
            currentDocument.name = file.name;
            currentDocument.fileSizeMB = fileSizeMB;
            currentDocument.id = Date.now().toString(); 
            currentDocument.translatedText = null;
            currentDocument.keyConcepts = { keywords: [], laws: [] }; 

            fileNameDisplay.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹: ${file.name} (${fileSizeMB}MB). Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©.`;
            analyzeButton.disabled = true;
            summarizeButton.disabled = true;
            extractConceptsButton.disabled = true; 
            
            // Determine if the file is an image/pdf or pure text
            const isImageOrPdf = file.type.startsWith('image/') || file.type === 'application/pdf';

            reader.onload = async (e) => {
                
                if (isImageOrPdf) {
                    currentDocument.base64Data = e.target.result.split(',')[1];
                    currentDocument.mimeType = file.type;
                    
                    // Trigger AI to convert non-text content to English text for original display
                    await generateOriginalTextFromMultimodal(currentDocument.base64Data, currentDocument.mimeType);
                    
                } else {
                    currentDocument.originalText = e.target.result;
                    currentDocument.base64Data = null;
                    currentDocument.mimeType = 'text/plain';
                    document.getElementById('original-lang').textContent = 'Ù†Øµ/Ù…Ø³ØªÙ†Ø¯';
                }

                // Show full text in original content pane
                document.getElementById('original-content').textContent = currentDocument.originalText || 'ÙØ´Ù„ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ.';
                document.getElementById('translated-content').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ±Ø¬Ù…Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" Ø£Ùˆ "ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰" Ù„Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                
                // Enable buttons only after the file is read fully and stored in state
                analyzeButton.disabled = false;
                summarizeButton.disabled = false;
                extractConceptsButton.disabled = false;
                
            };

            // Read as Data URL for base64 (for images/pdf) or as text (for text files)
            if (isImageOrPdf) {
                reader.readAsDataURL(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        /** Uses Gemini to convert multimodal input (image/PDF) to plain English text for display. */
        async function generateOriginalTextFromMultimodal(base64Data, mimeType) {
            try {
                document.getElementById('original-lang').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù†Øµ...';
                
                const payload = {
                    contents: [{ parts: [
                        { inlineData: { mimeType: mimeType, data: base64Data } },
                        { text: "Extract all text present in the image/document and output it as a single block of English text. If the original language is not English, translate it to English first. Do not add any extra commentary or introductory phrases. Start directly with the extracted text." }
                    ] }],
                };

                const response = await geminiFetch(API_URL_FLASH, payload, 3); // Max 3 retries for speed

                const aiText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                currentDocument.originalText = aiText;
                document.getElementById('original-lang').textContent = 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø£ØµÙ„';
            } catch (error) {
                console.error("Failed to extract original text from multimodal content:", error);
                currentDocument.originalText = `(ÙØ´Ù„ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ. Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©)`;
                document.getElementById('original-lang').textContent = 'Ø®Ø·Ø£/ØµÙˆØ±Ø©';
            }
        }


        /** Saves the current document data to the Firestore Library. */
        async function saveDocumentToLibrary(docData) {
            try {
                if (!window.isAuthReady()) return; 
                const { addDoc, collection, serverTimestamp } = window.firestoreImports;
                const libraryRef = collection(window.db, `artifacts/${appId}/public/data/teacher_ai_library`);
                
                const libraryItem = {
                    name: docData.name,
                    timestamp: serverTimestamp(),
                    userId: window.getUserId(),
                    originalText: docData.originalText, 
                    translatedText: docData.translatedText,
                    keyConcepts: docData.keyConcepts || { keywords: [], laws: [] }, 
                    mimeType: docData.mimeType,
                    fileSizeMB: docData.fileSizeMB 
                };

                const newDocRef = await addDoc(libraryRef, libraryItem);
                currentDocument.id = newDocRef.id;
                await saveLastOpenedFile(newDocRef.id);
                
            } catch (error) {
                console.error(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©: ${error.message}`);
            }
        }

        /** Saves the ID of the last opened file to user's private preferences. */
        async function saveLastOpenedFile(fileId) {
             try {
                if (!window.isAuthReady()) return; 
                const { doc, setDoc } = window.firestoreImports;
                const userId = window.getUserId();
                const prefsRef = doc(window.db, `artifacts/${appId}/users/${userId}/teacher_ai_user_data/preferences/`);
                await setDoc(prefsRef, { lastOpenedFileId: fileId }, { merge: true });
            } catch (error) {
                console.error("Failed to save last opened file preference:", error);
            }
        }
        
        /** Loads the last opened file from user preferences. */
        window.loadLastOpenedFile = async function() {
            try {
                if (!window.isAuthReady()) return; 
                const { doc, getDoc } = window.firestoreImports;
                const userId = window.getUserId();
                const prefsRef = doc(window.db, `artifacts/${appId}/users/${userId}/teacher_ai_user_data/preferences/`);
                const prefsSnap = await getDoc(prefsRef);

                if (prefsSnap.exists() && prefsSnap.data().lastOpenedFileId) {
                    const lastFileId = prefsSnap.data().lastOpenedFileId;
                    
                    const libraryDocRef = doc(window.db, `artifacts/${appId}/public/data/teacher_ai_library`, lastFileId);
                    const fileSnap = await getDoc(libraryDocRef);

                    if (fileSnap.exists()) {
                        const data = fileSnap.data();
                        loadDocumentIntoUI(fileSnap.id, data);
                    }
                }
            } catch (error) {
                console.error("Failed to load last opened file:", error);
            }
        }


        // --- 4. Gemini API Calls (MAXIMUM Speed Focus) ---

        /** Handles Translation and Analysis using Gemini (Optimized for speed/depth). */
        window.translateAndAnalyze = async function() {
            if (!currentDocument.name) return handleError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.");

            // IMPROVED LOADING MESSAGE FOR FAST UX PERCEPTION
            const loadingMessage = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (${currentDocument.fileSizeMB}MB)... Ù†Ø±Ø¬Ùˆ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¶Ø¹ Ù„Ø­Ø¸Ø§Øª.`;
            showLoading(loadingMessage);
            const retryFn = () => window.translateAndAnalyze();
            
            try {
                document.getElementById('analyze-button').disabled = true;
                
                let parts = [];
                // MAX SPEED SYSTEM PROMPT: Focus ONLY on full translation.
                let systemPrompt = `Ø£Ù†Øª Ù…ØªØ±Ø¬Ù… Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù…Ø­ØªØ±Ù. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ **ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„** Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰. Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„Ø´Ø±Ø­ Ø£Ùˆ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø£Ùˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬ Ù‡Ùˆ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØªØ±Ø¬Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ ÙˆØ¨Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø©.`;

                // Add content parts
                if (currentDocument.base64Data) {
                    parts.push({
                        inlineData: {
                            mimeType: currentDocument.mimeType,
                            data: currentDocument.base64Data
                        }
                    });
                    parts.push({ text: "Ù‚Ù… Ø¨ØªØ±Ø¬Ù…Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø³Ø±Ø¹Ø©." });
                } else {
                    parts.push({ text: `Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ: \n\n${currentDocument.originalText}` });
                }

                const payload = {
                    contents: [{ parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await geminiFetch(API_URL_FLASH, payload);
                closeModal();

                const aiText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiText) throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.");
                
                // Update UI and state
                currentDocument.translatedText = aiText;
                document.getElementById('translated-content').textContent = aiText;
                
                // Save results to library (Asynchronous, non-blocking)
                saveDocumentToLibrary(currentDocument);

            } catch (error) {
                handleError(`ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„Ø´Ø±Ø­: ${error.message}`, retryFn);
            } finally {
                 document.getElementById('analyze-button').disabled = false;
            }
        }
        
         /** FEATURE: Summarizes the current document quickly. */
        window.summarizeDocument = async function() {
            if (!currentDocument.originalText) return handleError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙ„Ø®ÙŠØµÙ‡.");

            const loadingMessage = `Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ (${currentDocument.fileSizeMB}MB)... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.`;
            showLoading(loadingMessage);
            const retryFn = () => window.summarizeDocument();

            try {
                document.getElementById('summarize-button').disabled = true;
                
                let parts = [];
                // MAX SPEED SYSTEM PROMPT for summary
                let systemPrompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø¯Ù… ÙÙŠ 3-4 Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø·. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø³Ø±ÙŠØ¹Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ Ù…ÙƒØ«ÙØ§Ù‹ØŒ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© (Executive Summary)ØŒ Ùˆ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;

                // Add content parts (using base64 for multimodal if available)
                if (currentDocument.base64Data) {
                    parts.push({
                        inlineData: {
                            mimeType: currentDocument.mimeType,
                            data: currentDocument.base64Data
                        }
                    });
                    parts.push({ text: "Ù‚Ù… Ø¨ØªÙ„Ø®ÙŠØµ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ©." });
                } else {
                    parts.push({ text: `Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ: \n\n${currentDocument.originalText}` });
                }

                const payload = {
                    contents: [{ parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await geminiFetch(API_URL_FLASH, payload);
                closeModal();

                const aiText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiText) throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù† ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ø®ÙŠØµ.");
                
                // Display summary in the translated content pane
                const summaryHtml = `
                    <h3 class="text-lg font-bold text-orange-700 border-b pb-2 mb-2">âœ¨ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ âœ¨</h3>
                    <pre class="whitespace-pre-wrap text-sm text-gray-800 mt-2 text-left-ar">${aiText}</pre>
                `;
                document.getElementById('translated-content').innerHTML = summaryHtml;
                
            } catch (error) {
                handleError(`ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø³Ø±ÙŠØ¹: ${error.message}`, retryFn);
            } finally {
                 document.getElementById('summarize-button').disabled = false;
            }
        }


        /** NEW: Triggers the extraction of concepts from the current document and displays them in the sidebar. */
        window.extractConceptsToSidebar = async function() {
             if (!currentDocument.originalText) return handleError("ÙŠØ¬Ø¨ Ø±ÙØ¹ ÙˆØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ….");

            const loadingMessage = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ… (${currentDocument.fileSizeMB}MB)... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¶Ø¹ Ù„Ø­Ø¸Ø§Øª.`;
            showLoading(loadingMessage);
            const retryFn = () => window.extractConceptsToSidebar();

            try {
                document.getElementById('extract-concepts-button').disabled = true;

                // --- CRITICAL: AI is now asked to output a structured JSON for easy parsing ---
                let parts = [];
                let systemPrompt = `Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø®Ø¨ÙŠØ±. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø¯Ù….
                1. Ø§Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… 10 ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© (Keywords) Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
                2. Ø§Ø³ØªØ®Ø±Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø£Ùˆ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)ØŒ Ù…Ø¹ ÙƒØªØ§Ø¨ØªÙ‡Ø§ ÙÙŠ ØµÙŠØºØ© LaTeX.
                3. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ÙƒØ§Ø¦Ù† JSON Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:
                {
                    "keywords": [ "ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ© 1", "ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ© 2", ...],
                    "laws": [ "Ù‚Ø§Ù†ÙˆÙ† 1 Ø¨ØµÙŠØºØ© LaTeX", "Ù‚Ø§Ù†ÙˆÙ† 2 Ø¨ØµÙŠØºØ© LaTeX", ...]
                }`;

                if (currentDocument.base64Data) {
                    parts.push({
                        inlineData: { mimeType: currentDocument.mimeType, data: currentDocument.base64Data }
                    });
                    parts.push({ text: "Ù‚Ù… Ø¨Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… ÙˆØ§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù." });
                } else {
                    parts.push({ text: `Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ: \n\n${currentDocument.originalText}` });
                }

                const payload = {
                    contents: [{ parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "keywords": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "laws": { "type": "ARRAY", "items": { "type": "STRING" } }
                            }
                        }
                    }
                };

                const response = await geminiFetch(API_URL_FLASH, payload);
                closeModal();

                const jsonText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                
                const result = JSON.parse(jsonText);
                
                // Update state and display sidebar
                const keywords = Array.isArray(result.keywords) ? result.keywords : [];
                const laws = Array.isArray(result.laws) ? result.laws : [];
                
                displayKeyConcepts(keywords, laws);
                
                // Update the saved document in the Library immediately after successful extraction (async)
                if (currentDocument.id) {
                    const { doc, updateDoc } = window.firestoreImports;
                    const docRef = doc(window.db, `artifacts/${appId}/public/data/teacher_ai_library`, currentDocument.id);
                    await updateDoc(docRef, { keyConcepts: { keywords, laws } });
                }

            } catch (error) {
                handleError(`ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…: ${error.message}`, retryFn);
            } finally {
                 document.getElementById('extract-concepts-button').disabled = false;
            }
        }

        /** NEW: Searches the smart library (web) for a book/topic and loads it as a document. */
        window.searchSmartLibrary = async function() {
            const input = document.getElementById('library-search-input');
            const queryText = input.value.trim();
            if (!queryText) return;

            const loadingMessage = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "${queryText}" ÙˆØ§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ...`;
            showLoading(loadingMessage);
            const retryFn = () => window.searchSmartLibrary();
            document.getElementById('library-search-button').disabled = true;

            try {
                // Use Gemini to perform a grounded search and extract the full content
                const systemPrompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¨Ø­Ø«ØŒ Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø« Ù…Ø¹Ù…Ù‚ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø«Ù„ Ø§Ù„ÙØµÙˆÙ„ Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) Ù„Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. Ù‚Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠ Ø´ÙƒÙ„ Ù†Øµ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙˆØ§Ø¶Ø­ ÙˆÙ…ÙØµÙ„ ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„Ø§Ø­Ù‚Ø©.`;
                
                const payload = {
                    contents: [{ parts: [{ text: `Search for the full content/detailed summary of the academic book or document titled: "${queryText}". Output the extracted content in English.` }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await geminiFetch(API_URL_FLASH, payload);
                closeModal();

                const aiText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiText) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.");

                // Load the search result as a new document
                currentDocument = {
                    id: Date.now().toString(),
                    name: `Ø¨Ø­Ø«: ${queryText}`,
                    fileSizeMB: (aiText.length / 1024).toFixed(2), 
                    originalText: aiText,
                    translatedText: null,
                    base64Data: null, 
                    mimeType: 'text/plain',
                    keyConcepts: { keywords: [], laws: [] }
                };

                // Update UI to show the new document
                document.getElementById('file-name-display').textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙØªÙˆØ­: ${currentDocument.name} (${currentDocument.fileSizeMB}KB)`;
                document.getElementById('original-content').textContent = currentDocument.originalText;
                document.getElementById('original-lang').textContent = 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø£ØµÙ„';
                document.getElementById('translated-content').textContent = 'ØªÙ… Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ø¯ Ø¥Ù„Ù‰ "Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ" Ù„ØªØ±Ø¬Ù…ØªÙ‡.';
                
                displayKeyConcepts([], []); // Clear old concepts

                // Enable document processing buttons
                document.getElementById('analyze-button').disabled = false;
                document.getElementById('summarize-button').disabled = false;
                document.getElementById('extract-concepts-button').disabled = false;

                // Display a summary of the action in the search results pane
                document.getElementById('library-search-results').innerHTML = `
                    <div class="bg-green-100 p-4 rounded-lg border border-green-300">
                        <p class="text-green-800 font-bold mb-2">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨!</p>
                        <p class="text-green-700">ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ **"Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ"** Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø£Ùˆ Ø§Ù„ØªÙ„Ø®ÙŠØµ.</p>
                        <p class="text-xs text-gray-600 mt-2">Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${currentDocument.fileSizeMB}KB</p>
                    </div>
                `;

                // Switch to document tab automatically after search
                changeTab('document');


            } catch (error) {
                handleError(`ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©: ${error.message}`, retryFn);
                document.getElementById('library-search-results').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg border border-red-300">
                        <p class="text-red-800 font-bold mb-2">Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«!</p>
                        <p class="text-red-700">ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØªØ§Ø¨: ${error.message}</p>
                    </div>
                `;
            } finally {
                document.getElementById('library-search-button').disabled = false;
            }
        }


        // --- 5. AI Chat Functionality (MAXIMUM Speed Focus) ---

        /** Sends message to AI Chat and updates UI. */
        window.sendAIChatMessage = async function() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            document.getElementById('ai-send-button').disabled = true;

            // Add user message to UI and history
            appendAIChatMessage(message, 'user');
            
            // Only keep the last 5 exchanges in history (10 messages) to maintain performance/speed
            aiChatHistory.push({ role: "user", parts: [{ text: message }] });
            if (aiChatHistory.length > 10) { 
                aiChatHistory = aiChatHistory.slice(-10);
            }
            
            // Show loading placeholder immediately with Deep Thinking message
            const placeholderId = `loading-${Date.now()}`;
            // Faster loading message
            appendAIChatMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚ Ø¬Ø¯Ø§Ù‹...', 'ai', placeholderId);
            scrollToBottom('ai-chat-messages');

            try {
                // Pass the limited history to the API for quick response with context
                const payload = {
                    contents: aiChatHistory,
                    tools: [{ "google_search": {} }], 
                    systemInstruction: { parts: [{ text: "Ø£Ù†Øª Ù…Ø¹Ù„Ù… Ø¢Ù„ÙŠ Ù…ØªÙ‚Ø¯Ù…ØŒ Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù‡ÙŠ **Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©** ÙÙŠ Ø§Ù„Ø±Ø¯ØŒ ÙŠÙ„ÙŠÙ‡ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± ÙˆØ¯Ù‚ÙŠÙ‚." }] }
                };

                const response = await geminiFetch(API_URL_FLASH, payload);

                // Remove loading placeholder
                const loadingEl = document.getElementById(placeholderId);
                if (loadingEl) loadingEl.remove();

                const aiText = response.candidates?.[0]?.content?.parts?.[0]?.text || "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙŠØ¬Ø§Ø¯ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§ÙÙŠØ© Ø¨Ø³Ø±Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
                
                // Update history and UI
                aiChatHistory.push({ role: "model", parts: [{ text: aiText }] });
                
                appendAIChatMessage(aiText, 'ai');

            } catch (error) {
                const loadingEl = document.getElementById(placeholderId);
                if (loadingEl) loadingEl.remove();
                // Specific error message in the chat box itself
                appendAIChatMessage(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ: ${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`, 'error');
                console.error("AI Chat Error:", error);
            } finally {
                document.getElementById('ai-send-button').disabled = false;
                scrollToBottom('ai-chat-messages');
                input.focus();
            }
        }

        /** Helper function to append messages to AI Chat UI. */
        function appendAIChatMessage(text, role, id = null) {
            const container = document.getElementById('ai-chat-messages');
            const isUser = role === 'user';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            if (id) messageDiv.id = id;

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl max-w-[80%] shadow-md text-sm whitespace-pre-wrap ${isUser ? 'bg-blue-600 text-white rounded-bl-none' : 'bg-gray-200 text-gray-800 rounded-br-none'}`;
            
            if (!isUser) {
                const roleEl = document.createElement('p');
                roleEl.className = 'font-bold text-blue-800 mb-1';
                roleEl.textContent = role === 'error' ? 'Ø®Ø·Ø£:' : 'Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ:';
                if (role !== 'error') bubble.appendChild(roleEl);
            }

            const textNode = document.createElement('p');
            textNode.textContent = text;
            bubble.appendChild(textNode);
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            scrollToBottom('ai-chat-messages');
        }


        // --- 6. Firestore Listeners and Data Management ---

        /** Sets up all required Firestore listeners. */
        function startFirestoreListeners(userId) {
            setupGroupChatListener();
            setupLibraryListener();
        }

        /** Sets up real-time listener for Group Chat messages (More frequent update). */
        function setupGroupChatListener() {
            if (!window.isAuthReady()) return; 
            const { collection, query, onSnapshot } = window.firestoreImports;
            // Query without orderBy for potential speed optimization, sorting client-side
            const chatQuery = query(collection(window.db, `artifacts/${appId}/public/data/teacher_ai_group_chat`)); 
            
            onSnapshot(chatQuery, (snapshot) => {
                const messages = [];
                snapshot.docs.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort client-side by timestamp to keep order correct
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                displayGroupChatMessages(messages);
            }, (error) => {
                console.error("Group Chat Listener Error:", error);
                document.getElementById('group-chat-messages').innerHTML = `<p class="text-center text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.</p>`;
            });
        }
        
        /** Displays group chat messages in the sidebar. */
        function displayGroupChatMessages(messages) {
            const container = document.getElementById('group-chat-messages');
            container.innerHTML = ''; // Clear messages before redrawing
            
            if (messages.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 pt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù†Ù‚Ø§Ø´!</p>`;
                return;
            }

            messages.forEach(msg => {
                const isMine = msg.userId === window.getUserId();
                const time = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : 'Ø§Ù„Ø¢Ù†';

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `p-2 rounded-xl max-w-[90%] shadow-sm text-xs ${isMine ? 'bg-blue-100 rounded-bl-lg' : 'bg-gray-100 rounded-br-lg'}`;
                
                const userEl = document.createElement('p');
                userEl.className = `font-bold mb-1 ${isMine ? 'text-blue-700' : 'text-gray-700'}`;
                userEl.textContent = isMine ? 'Ø£Ù†Øª' : `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${msg.userId.substring(0, 8)}...`;
                bubble.appendChild(userEl);

                const textEl = document.createElement('p');
                textEl.textContent = msg.message;
                bubble.appendChild(textEl);

                const timeEl = document.createElement('span');
                timeEl.className = 'block text-left-ar mt-1 text-[10px] text-gray-500';
                timeEl.textContent = time;
                bubble.appendChild(timeEl);

                messageDiv.appendChild(bubble);
                container.appendChild(messageDiv);
            });
            scrollToBottom('group-chat-messages');
        }

        /** Sends a message to the public group chat. */
        window.sendGroupChatMessage = async function() {
            const input = document.getElementById('group-chat-input');
            const message = input.value.trim();
            if (!message || !window.isAuthReady()) return; 

            input.value = '';
            input.disabled = true;

            try {
                const { addDoc, collection, serverTimestamp } = window.firestoreImports;
                const chatRef = collection(window.db, `artifacts/${appId}/public/data/teacher_ai_group_chat`);

                await addDoc(chatRef, {
                    message: message,
                    userId: window.getUserId(),
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                handleError(`ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©: ${error.message}`);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        /** Sets up real-time listener for the Smart Library. */
        function setupLibraryListener() {
            if (!window.isAuthReady()) return; 
            const { collection, query, orderBy, onSnapshot } = window.firestoreImports;
            const libraryQuery = query(collection(window.db, `artifacts/${appId}/public/data/teacher_ai_library`), orderBy("timestamp", "desc"));

            onSnapshot(libraryQuery, (snapshot) => {
                const documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayLibraryDocuments(documents);
            }, (error) => {
                console.error("Library Listener Error:", error);
                document.getElementById('library-loading').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©.';
            });
        }
        
        /** Displays library documents in the sidebar. */
        function displayLibraryDocuments(documents) {
            const container = document.getElementById('library-list');
            const loadingMsg = document.getElementById('library-loading');
            container.innerHTML = '';
            loadingMsg.classList.add('hidden');
            
            if (documents.length === 0) {
                loadingMsg.textContent = 'Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø±ÙØ¹ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ÙˆÙ„!';
                loadingMsg.classList.remove('hidden');
                return;
            }

            documents.forEach(docData => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-white rounded-lg border border-gray-100 shadow-sm cursor-pointer hover:bg-blue-50 transition';
                item.setAttribute('onclick', `openLibraryDocument('${docData.id}')`);

                const text = document.createElement('span');
                text.className = 'truncate text-gray-700 text-sm';
                text.textContent = docData.name;
                item.appendChild(text);

                const icon = document.createElement('span');
                icon.className = 'text-blue-500 text-xs font-bold';
                icon.textContent = docData.mimeType.includes('image') ? 'ØµÙˆØ±Ø©' : docData.mimeType.includes('pdf') ? 'PDF' : 'Ù†Øµ';
                item.appendChild(icon);

                container.appendChild(item);
            });
        }

        /** Opens a document from the library and updates the main view. */
        window.openLibraryDocument = function(docId) {
            showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©...");
            
            try {
                const { doc, getDoc } = window.firestoreImports;
                const docRef = doc(window.db, `artifacts/${appId}/public/data/teacher_ai_library`, docId);
                
                getDoc(docRef).then(snap => {
                    if (snap.exists()) {
                        const data = snap.data();
                        loadDocumentIntoUI(snap.id, data);
                        // Update Key Concepts from saved data
                        displayKeyConcepts(data.keyConcepts?.keywords, data.keyConcepts?.laws);
                        closeModal();
                        saveLastOpenedFile(snap.id);
                    } else {
                        throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©.");
                    }
                }).catch(error => handleError(`ÙØ´Ù„ ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù…ÙƒØªØ¨Ø©: ${error.message}`));

            } catch (error) {
                handleError(`ÙØ´Ù„ ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù…ÙƒØªØ¨Ø©: ${error.message}`);
            }
        }

        /** Loads document data into the main UI view. */
        function loadDocumentIntoUI(id, data) {
            currentDocument.id = id;
            currentDocument.name = data.name;
            currentDocument.fileSizeMB = data.fileSizeMB || 0; 
            currentDocument.originalText = data.originalText;
            currentDocument.translatedText = data.translatedText;
            currentDocument.keyConcepts = data.keyConcepts || { keywords: [], laws: [] };
            currentDocument.mimeType = data.mimeType || 'text/plain';
            
            document.getElementById('file-name-display').textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙØªÙˆØ­: ${data.name} (${currentDocument.fileSizeMB}MB)`;
            document.getElementById('original-content').textContent = currentDocument.originalText || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ø£ØµÙ„ÙŠ.';
            document.getElementById('original-lang').textContent = 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø£ØµÙ„';
            document.getElementById('translated-content').textContent = currentDocument.translatedText || 'Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªØ±Ø¬Ù…Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø¹Ø¯.';
            
            // Ensure buttons reflect state
            const buttonsDisabled = !currentDocument.originalText;
            document.getElementById('analyze-button').disabled = buttonsDisabled;
            document.getElementById('summarize-button').disabled = buttonsDisabled;
            document.getElementById('extract-concepts-button').disabled = buttonsDisabled;
            
            // Display concepts from loaded data
            displayKeyConcepts(currentDocument.keyConcepts.keywords, currentDocument.keyConcepts.laws); 

            changeTab('document');
        }

        /** Displays extracted key concepts and laws in the sidebar. */
        function displayKeyConcepts(keywords, laws) {
            const safeKeywords = Array.isArray(keywords) ? keywords : [];
            const safeLaws = Array.isArray(laws) ? laws : [];
            
            const container = document.getElementById('key-concepts-display');
            container.innerHTML = '';

            const keywordList = safeKeywords.map(k => `<span class="inline-block bg-blue-200 text-blue-800 text-xs px-3 py-1 rounded-full font-medium shadow-sm">${k}</span>`).join(' ');
            
            let lawsHtml = '';
            if (safeLaws.length > 0) {
                lawsHtml = `
                    <h4 class="font-bold mt-4 mb-2 text-blue-700">Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† (ØµÙŠØºØ© LaTeX):</h4>
                    <div class="space-y-2">
                        ${safeLaws.map(l => `<div class="p-2 bg-white border border-blue-100 rounded-lg text-xs font-mono text-gray-800 overflow-x-auto">$$${l}$$</div>`).join('')}
                    </div>
                `;
            } else {
                lawsHtml = '<p class="text-sm text-gray-500 mt-2">Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø±ÙŠØ§Ø¶ÙŠØ© Ø£Ùˆ ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©.</p>';
            }

            container.innerHTML = `
                <h4 class="font-bold mb-2 text-blue-700">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©:</h4>
                <div class="flex flex-wrap gap-2">${keywordList || '<p class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…Ø³ØªØ®Ù„ØµØ©.</p>'}</div>
                ${lawsHtml}
            `;

            // Update global state
            currentDocument.keyConcepts.keywords = safeKeywords;
            currentDocument.keyConcepts.laws = safeLaws;
        }

        /** Scrolls the given element to the bottom. */
        function scrollToBottom(elementId) {
            const element = document.getElementById(elementId);
            element.scrollTop = element.scrollHeight;
        }

        // --- Initial Setup on Window Load ---
        window.onload = function() {
            document.getElementById('access-key-input').focus();
            changeTab('document');
            document.body.style.fontFamily = "'Cairo', sans-serif";
            
            if (!window.isAuthReady()) { 
                 document.getElementById('library-loading').textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
            }
        };

    </script>
</body>
</html>
